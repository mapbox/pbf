<!DOCTYPE html>
<html>
<head>
    <title>debug page</title>
    <meta charset='utf-8'>
</head>
<body>
    <script src='../pbf-dev.js'></script>
    <script src='data.js'></script>
    <script>
        console.time('decode');
        for (var i = 0; i < 10; i++) readLayers(data);
        console.timeEnd('decode');

        var layers = readLayers(data),
            layersJSON = JSON.stringify(layers);

        console.time('encode');
        for (var i = 0; i < 10; i++) encodeLayers(layers);
        console.timeEnd('encode');

        console.time('JSON.parse');
        for (var i = 0; i < 10; i++) JSON.parse(layersJSON);
        console.timeEnd('JSON.parse');

        console.time('JSON.stringify');
        for (var i = 0; i < 10; i++) JSON.stringify(layers);
        console.timeEnd('JSON.stringify');

        // decoding vector tile

        function readLayers(data) {
            return new Pbf(new Uint8Array(data)).readFields(readTile, []);
        }
        function readTile(tag, layers, pbf) {
            if (tag === 3) layers.push(pbf.readMessage(readLayer, {features: [], keys: [], values: []}));
        }
        function readLayer(tag, layer, pbf) {
            if (tag === 1) layer.name = pbf.readString();
            else if (tag === 2) layer.features.push(pbf.readMessage(readFeature, {}));
            else if (tag === 3) layer.keys.push(pbf.readString());
            else if (tag === 4) layer.values.push(readValue(pbf));
            else if (tag === 5) layer.extent = pbf.readVarint();
            else if (tag === 15) layer.version = pbf.readVarint();
        }
        function readFeature(tag, feature, pbf) {
            if (tag === 1) feature.id = pbf.readVarint();
            else if (tag === 2) feature.tags = pbf.readPackedVarint();
            else if (tag === 3) feature.type = pbf.readVarint();
            else if (tag === 4) feature.geometry = pbf.readPackedVarint();
        }
        function readValue(pbf) {
            var end = pbf.readVarint() + pbf.pos;

            while (pbf.pos < end) {
                var val = pbf.readVarint(),
                    tag = val >> 3;

                if (tag === 1) return pbf.readString();
                else if (tag === 2) return pbf.readFloat();
                else if (tag === 3) return pbf.readDouble();
                else if (tag === 4) return pbf.readVarint();
                else if (tag === 5) return pbf.readVarint();
                else if (tag === 6) return pbf.readSVarint();
                else if (tag === 7) return pbf.readBoolean();
                else pbf.skip(val);
            }
            return null;
        }


        // encoding vector tile

        function encodeLayers(layers) {
            var pbf = new Pbf();
            for (var i = 0; i < layers.length; i++) {
                pbf.writeMessage(3, encodeLayer(layers[i]));
            }
            return pbf.finish();
        }
        function encodeLayer(layer) {
            var pbf = new Pbf();
            pbf.writeStringField(1, layer.name);

            for (var i = 0; i < layer.features.length; i++) {
                pbf.writeMessage(2, encodeFeature(layer.features[i]));
            }
            for (i = 0; i < layer.keys.length; i++) {
                pbf.writeStringField(3, layer.keys[i]);
            }
            for (i = 0; i < layer.values.length; i++) {
                pbf.writeMessage(4, encodeValue(layer.values[i]));
            }
            pbf.writeVarintField(5, layer.extent);
            pbf.writeVarintField(15, layer.version);
            return pbf;
        }
        function encodeFeature(feature) {
            var pbf = new Pbf();
            pbf.writeVarintField(1, feature.id);
            pbf.writePackedVarint(2, feature.tags);
            pbf.writeVarintField(3, feature.type);
            pbf.writePackedVarint(4, feature.geometry);
            return pbf;
        }
        function encodeValue(value) {
            var pbf = new Pbf();
            if (typeof value === 'string') pbf.writeStringField(1, value);
            else if (typeof value === 'number') {
                if (value % 1 === 0) { // integer
                    if (value >= 0) pbf.writeVarintField(4, value);
                    else pbf.writeSVarintField(6, value);
                } else pbf.writeDoubleField(3, value);
            } else if (typeof value === 'boolean') pbf.writeBooleanField(7, value);
            return pbf;
        }

    </script>
</body>
</html>
